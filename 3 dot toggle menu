<?php
session_start();
include 'db.php';

if (!isset($_SESSION['user_id'], $_POST['user_id'])) {
    die("Error: Invalid request.");
}

$currentUser = intval($_SESSION['user_id']);
$chatUser    = intval($_POST['user_id']);

$sql = "
  SELECT id, sender_id, message, image_path, timestamp
  FROM messages
  WHERE (sender_id = ? AND receiver_id = ?)
     OR (sender_id = ? AND receiver_id = ?)
  ORDER BY timestamp ASC
";
$stmt = $conn->prepare($sql);
$stmt->bind_param("iiii", $currentUser, $chatUser, $chatUser, $currentUser);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows) {
    while ($row = $result->fetch_assoc()) {
        $isSender = ($row['sender_id'] === $currentUser);
        $cls      = $isSender ? 'sent-message' : 'received-message';
        $text     = htmlspecialchars($row['message'], ENT_QUOTES, 'UTF-8');
        $time     = date('h:i A', strtotime($row['timestamp']));
        $image_path = $row['image_path'];

        echo "<div class=\"message {$cls} p-2 mb-2 rounded\" data-message-id=\"{$row['id']}\">";
          echo "<small class=\"text-muted d-block\">{$time}</small>";
          if ($image_path) {
              echo "<img src='{$image_path}' class='img-fluid rounded chat-image' style='max-height: 200px; margin-bottom: 5px; cursor: pointer;'>";
          }
          if ($text) {
            echo "<span class=\"message-text\">{$text}</span>";
          }

          // three-dot menu
          echo '<div class="message-actions">';
            echo '<span class="action-toggle">&#8942;</span>';
            echo '<div class="action-menu">';

              // header with time
              echo "<div class=\"action-header\">{$time}</div>";

              // list of actions
              echo '<div class="action-list">';
                if ($isSender) {
                  echo '<div class="action-item edit-action">';
                    echo '<img src="assets/img/icons/edit.svg" alt="Edit" class="action-icon"> Edit';
                  echo '</div>';

                  echo '<div class="action-item forward-action">';
                    echo '<img src="assets/img/icons/forward.svg" alt="Forward" class="action-icon"> Forward';
                  echo '</div>';
                }
                echo '<div class="action-item copy-action">';
                  echo '<img src="assets/img/icons/copy.svg" alt="Copy" class="action-icon"> Copy';
                echo '</div>';
                if ($isSender) {
                  echo '<div class="action-divider"></div>';
                  echo '<div class="action-item unsend-action">';
                    echo '<img src="assets/img/icons/unsend.svg" alt="Unsend" class="action-icon"> Unsend';
                  echo '</div>';
                }
              echo '</div>';  // .action-list

            echo '</div>';    // .action-menu
          echo '</div>';      // .message-actions

        echo "</div>";
    }
} else {
    echo '<p class="text-center">No messages yet.</p>';
}

$stmt->close();
$conn->close();
?>
